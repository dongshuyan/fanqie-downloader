# 番茄小说下载器 - 优化增强版

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://python.org)
[![License](https://img.shields.io/badge/License-AGPL--3.0-green.svg)](LICENSE)
[![Status](https://img.shields.io/badge/Status-Active-success.svg)]()

> **基于 [ying-ck/fanqienovel-downloader](https://github.com/ying-ck/fanqienovel-downloader) 的优化增强版本**

一个高效、稳定的番茄小说下载器，修复了原版的多个关键问题，提升了下载速度和文件质量。

## ✨ 主要改进

### 🚀 性能优化
- **Cookie获取加速**: 从原版的18秒优化到1秒，大幅减少等待时间
- **8线程并行下载**: 多线程并发下载不同章节，大幅提升下载速度
- **智能章节排序**: 自动按章节编号排序合并，支持缺失章节处理
- **网络请求优化**: 减少不必要的验证步骤，提升下载速度
- **智能重试机制**: 改进错误处理和重试逻辑

### 🔧 Bug修复
- **修复Cookie获取卡死问题**: 解决了原版在获取cookie时长时间卡住的问题
- **修复DownloadProgress错误**: 解决了`name 'DownloadProgress' is not defined`错误
- **修复TXT文件无法生成**: 确保每次下载都能正确生成TXT文件
- **完善字符解码**: 正确应用charset.json，彻底解决乱码问题

### 🛡️ 高级反爬策略 (NEW!)
- **策略2 - 激进Cookie管理**: 失败1次即刷新Cookie，每20章主动刷新
- **策略3 - 真实用户模拟**: 20+种真实浏览器请求头随机化，0-5秒智能暂停
- **高度逼真**: Chrome/Firefox/Safari/Edge完整模拟，包含Sec-Fetch、Sec-CH等现代头部
- **智能识别**: 根据User-Agent智能匹配对应浏览器的特有头部

### 📁 新增功能
- **并行下载**: 8线程并发下载，大幅提升下载速度
- **智能文件夹**: "书名-ID"格式的组织结构，清晰易管理
- **智能章节排序**: 自动按编号排序，支持缺失章节检测和提示
- **多层文件结构**: TXT、JSON、分章节文件分类存储
- **失败章节处理** (NEW!): 自动生成占位文件和error.log详细记录
- **完整性保证** (NEW!): 确保所有章节都有对应文件，失败章节显示"抓取内容为空"
- **精简测试工具**: 新增`test_download.py`用于快速测试下载功能
- **自动化测试**: 新增`auto_test.py`用于验证程序功能

## 🎯 快速开始

### 环境要求
- Python 3.8+
- 网络连接

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行程序
```bash
# 运行主程序(优化版本)
python src/main.py

# 或运行精简测试版本
python test_download.py
```

## 🛠️ 使用方法

### 主程序功能
1. **直接下载**: 输入小说ID或链接直接下载
2. **搜索下载**: 通过关键词搜索并选择小说
3. **批量下载**: 支持批量下载多本小说
4. **更新小说**: 更新已下载的小说
5. **多格式保存**: 支持TXT、EPUB、HTML、LaTeX格式
6. **设置调整**: 自定义保存路径、格式等选项

### 快速测试
```bash
# 测试下载指定小说(ID: 7520128677003136024)
python test_download.py

# 自动化测试main.py功能
python auto_test.py
```

## 🔥 核心特性

### ⚡ 并行下载
- **8线程并发**: 同时下载多个章节，大幅提升速度
- **智能调度**: 自动分配下载任务，最大化网络利用率
- **断点续传**: 支持中断后继续下载（原有功能保留）

### 🧠 智能排序
- **自动章节识别**: 支持"第X章"、"Chapter X"等多种格式
- **智能排序**: 按章节编号从小到大自动排序
- **缺失处理**: 自动检测缺失章节并标注"当前章节缺失"
- **示例**: 下载到1,5,4,2章 → 自动排序为1,2,4,5，第3章标记缺失

### 📁 智能文件管理
- **分层结构**: 
  - `src/novel_downloads/书名-ID/` - TXT文件
  - `src/bookstore/书名-ID/` - JSON备份
  - `Chapters/` - 分章节文件
- **防重名**: 使用"书名-ID"格式避免同名冲突
- **多格式**: 完整TXT + 分章节TXT + JSON备份

### 🛡️ 高级反爬策略详解
- **策略2 - 激进Cookie管理**:
  - 失败1次立即刷新Cookie（不再等3次）
  - 每20个章节主动刷新维持活跃状态
  - 详细的Cookie刷新日志记录
- **策略3 - 真实用户行为模拟**:
  - 20+种真实浏览器User-Agent随机轮换
  - 智能请求头组合：根据浏览器类型匹配对应特征
  - Chrome: Sec-Fetch系列 + Sec-CH客户端提示
  - Firefox/Safari: 对应的特有头部特征
  - 0-5秒随机暂停模拟真实阅读时间
  - 9种Accept-Language地区变化
  - 多种Cache-Control、Referer策略

### 📝 失败章节完整处理 (NEW!)
- **占位文件生成**: 失败章节自动创建TXT文件，内容显示"抓取内容为空"
- **error.log详细记录**: 
  ```
  # 章节下载失败记录
  # 生成时间: 2024-01-20 15:30:45
  # 失败章节总数: 3
  第37章 周婧怡，劫持 | 37 | 响应内容为空(None)
  第46章 谎言不会伤人 | 46 | 网络超时
  第179章 赵毅老畜生！ | 179 | 文件路径错误(变量为None)
  ```
- **完整性保证**: 确保所有章节都有对应文件，便于后续处理
- **智能失败原因**: 自动识别网络、解码、文件系统等不同类型错误

## 📊 支持的保存格式

| 格式 | 描述 | 文件扩展名 |
|------|------|-----------|
| 单文件TXT | 整本小说保存为一个文件 | `.txt` |
| 分章TXT | 每章单独保存 | `.txt` |
| EPUB | 电子书格式 | `.epub` |
| HTML | 网页格式 | `.html` |
| LaTeX | 学术文档格式 | `.tex` |

## 🔍 文件结构

### 程序文件结构
```
fanqienovel-downloader-enhanced/
├── src/
│   ├── main.py                    # 主程序(优化版本) ⭐
│   ├── server.py                  # Web版服务器
│   ├── charset.json               # 字符解码映射表
│   ├── novel_downloads/           # 小说TXT文件存储 ⭐
│   │   └── 书名-ID/
│   │       ├── 书名.txt           # 完整小说文件
│   │       ├── error.log          # 失败章节记录 ⭐ (NEW!)
│   │       └── Chapters/          # 分章节文件夹
│   │           ├── 第1章.txt
│   │           ├── 第37章.txt     # 失败章节(内容:"抓取内容为空")
│   │           └── ...
│   ├── bookstore/                 # JSON备份文件存储 ⭐
│   │   └── 书名-ID/
│   │       └── 书名.json          # 小说数据备份
│   └── data/                      # 配置和记录
├── test_download.py               # 精简测试下载器 ⭐
├── auto_test.py                   # 自动化测试脚本 ⭐
├── requirements.txt               # 依赖包列表
└── README.md                     # 项目说明
```

## 🆚 版本对比

| 功能 | 原版 | 优化版 |
|------|------|--------|
| Cookie获取速度 | 慢(可能卡死) | 快(1秒内) ⭐ |
| 下载方式 | 单线程 | 8线程并行 ⭐ |
| 章节排序 | 无序 | 智能排序 ⭐ |
| 缺失章节处理 | 跳过 | 智能提示 ⭐ |
| 文件组织 | 简单 | 智能文件夹 ⭐ |
| TXT文件生成 | 不稳定 | 稳定可靠 |
| 字符解码 | 部分乱码 | 完美解码 |
| 错误处理 | 基础 | 增强 |
| 测试工具 | 无 | 完整 |
| **反爬策略** | **基础** | **高级(20+种头部)** ⭐ |
| **失败章节处理** | **跳过丢失** | **完整记录+占位** ⭐ |
| **Cookie管理** | **保守(3次后刷新)** | **激进(1次即刷新)** ⭐ |

## 🐛 已修复的问题

1. **Cookie获取卡死**: 原版在`_get_new_cookie`中使用巨大循环范围导致卡死
2. **DownloadProgress未定义**: 类定义和引用不匹配
3. **TXT文件生成失败**: 缺少return语句和错误的元数据处理
4. **字符乱码**: charset.json解码逻辑不完整
5. **进度显示错误**: 进度回调函数参数不匹配
6. **大型小说反爬检测问题** (NEW!): 实施高级反爬策略，大幅降低失败率
7. **NoneType错误排查困难** (NEW!): 增加完整调试系统，强制输出网络响应内容
8. **失败章节丢失问题** (NEW!): 失败章节自动生成占位文件，保持小说完整性
9. **重试机制不触发** (NEW!): 修复重复检查逻辑，确保所有失败都触发重试

## 💡 使用建议

- **首次使用**: 推荐使用`test_download.py`进行快速测试
- **日常使用**: 使用`src/main.py`获得完整功能
- **批量下载**: 利用多线程设置提升下载速度
- **格式选择**: TXT格式兼容性最好，EPUB适合电子阅读

## 📱 跨平台支持

| 系统 | 状态 | 备注 |
|------|------|------|
| Windows 10/11 | ✅ 完全支持 | |
| macOS | ✅ 完全支持 | 已测试 |
| Linux | ✅ 完全支持 | |
| Android (Termux) | ✅ 支持 | 参考原版说明 |

## 🙏 致谢

本项目基于 [ying-ck/fanqienovel-downloader](https://github.com/ying-ck/fanqienovel-downloader) 开发，感谢原作者 **Yck (ying-ck)**、**Yqy (qxqycb)** 和 **Lingo (lingo34)** 的出色工作。

在原版基础上，我们专注于性能优化和bug修复，让这个优秀的工具更加稳定可靠。

## ⚠️ 免责声明

此程序仅用于学习和研究Python网络爬虫技术，请勿用于商业用途或侵犯版权的行为。使用者需遵守相关法律法规和网站使用条款，因使用本程序产生的任何法律责任由使用者自行承担。

## 📄 开源协议

本程序遵循 [AGPL-3.0](LICENSE) 开源协议。使用本程序源码时请注明来源，并使用相同的开源协议。

## 🔗 相关链接

- **原项目**: [ying-ck/fanqienovel-downloader](https://github.com/ying-ck/fanqienovel-downloader)
- **问题反馈**: [Issues](../../issues)
- **功能请求**: [Issues](../../issues)

---

📢 **如果这个项目对你有帮助，请给个 ⭐ Star 支持一下！**
